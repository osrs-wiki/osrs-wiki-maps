name: Generate Maps

on:
  workflow_dispatch:
    inputs:
      runner:
        description: "Runner to use for the job"
        required: false
        type: string
        default: "macos-latest-large"

jobs:
  generate-maps:
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11
          cache: maven

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip

      - name : Install python dependencies
        run: pip install -r requirements.txt

      - name: Install Maven dependencies
        run: mvn install -f pom.xml

      - name: Package Maven project
        run: mvn package -f pom.xml

      - name: Download latest cache
        run: python scripts/cache.py

      - name: Generate maps
        run: java -jar ./osrs-wiki-maps/target/osrs-wiki-maps-*-SNAPSHOT-shaded.jar

      - name: Stitch maps
        run: python scripts/stitch.py

      - name: Archive output
        run: |
          # Find the actual output directory (it will be under out/mapgen/versions/{version}/output)
          OUTPUT_DIR=$(find ./out -type d -name "output" | head -1)
          if [ -z "$OUTPUT_DIR" ]; then
            echo "Error: Could not find output directory"
            exit 1
          fi
          echo "Found output directory: $OUTPUT_DIR"
          # Create zip from within the output directory to avoid nested paths
          WORKING_DIR=$(pwd)
          cd "$OUTPUT_DIR"
          zip -r "$WORKING_DIR/maps-output.zip" .
          cd "$WORKING_DIR"

      - name: Upload output
        uses: actions/upload-artifact@v4
        with:
          name: maps-output-${{ github.run_id }}-${{ github.run_attempt }}
          path: maps-output.zip